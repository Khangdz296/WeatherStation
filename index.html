<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Weather Dashboard</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/modern-css-reset/dist/reset.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        padding: 16px;
        max-width: 1200px;
        margin: auto;
        background-color: #f5f5f5;
      }
      h1 {
        margin-bottom: 5px;
        color: #333;
      }
      .location-subtitle {
        color: #666;
        margin-bottom: 20px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .grid {
        display: grid;
        gap: 16px;
        margin-bottom: 20px;
      }
      .cards {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      .card {
        padding: 16px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .card.forecast {
        grid-column: span 2;
        background-color: #fff;
        transition: background-color 0.5s ease;
      }
      @media (max-width: 600px) {
        .card.forecast {
          grid-column: span 1;
        }
      }
      .muted {
        color: #888;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
      }
      .value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
      }
      .forecast-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #kpi-forecast-icon {
        font-size: 40px;
      }
      #map {
        height: 350px;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }
      .last-updated {
        text-align: right;
        font-size: 12px;
        color: #999;
        margin-top: -10px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <h1>üå•Ô∏è Tr·∫°m Quan Tr·∫Øc Th·ªùi Ti·∫øt</h1>

    <div class="location-subtitle">
      üìç <span id="address-text">ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...</span>
    </div>

    <div class="last-updated" id="updated">ƒêang t·∫£i d·ªØ li·ªáu...</div>

    <div class="grid cards">
      <div class="card forecast" id="card-forecast">
        <div class="muted">D·ª± B√°o Th·ªùi Ti·∫øt</div>
        <div class="forecast-container">
          <div id="kpi-forecast-icon">‚è≥</div>
          <div>
            <div id="kpi-forecast" class="value" style="font-size: 24px">
              ƒêang ph√¢n t√≠ch...
            </div>
            <div style="font-size: 12px; color: #666">
              D·ª±a tr√™n √°p su·∫•t & ƒë·ªô ·∫©m
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">Nhi·ªát ƒë·ªô</div>
        <div id="kpi-temp" class="value">-- ¬∞C</div>
      </div>
      <div class="card">
        <div class="muted">ƒê·ªô ·∫©m</div>
        <div id="kpi-hum" class="value">-- %</div>
      </div>
      <div class="card">
        <div class="muted">√Åp su·∫•t</div>
        <div id="kpi-press" class="value">-- hPa</div>
      </div>
      <div class="card">
        <div class="muted">√Ånh s√°ng</div>
        <div id="kpi-light" class="value">-- %</div>
      </div>
    </div>

    <h3>üìç B·∫£n ƒë·ªì tr·ª±c tuy·∫øn</h3>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-database-compat.js"></script>

    <script>
      // 1. C·∫§U H√åNH FIREBASE
      const firebaseConfig = {
        apiKey: "AIzaSyCGHeOKBOqgnjjG-H-oD50hIcXpQWOHZ0A",
        authDomain: "embeddedsystem-79380.firebaseapp.com",
        databaseURL:
          "https://embeddedsystem-79380-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "embeddedsystem-79380",
        storageBucket: "embeddedsystem-79380.firebasestorage.app",
        messagingSenderId: "1052320581332",
        appId: "1:1052320581332:web:61a10aa1319498b0c79d41",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // 2. KH·ªûI T·∫†O B·∫¢N ƒê·ªí
      const map = L.map("map").setView([10.7735, 106.7009], 15);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap",
      }).addTo(map);
      const marker = L.marker([10.7735, 106.7009])
        .addTo(map)
        .bindPopup("V·ªã tr√≠ thi·∫øt b·ªã")
        .openPopup();

      // 3. H√ÄM D·ª∞ B√ÅO TH·ªúI TI·∫æT
      function getWeatherForecast(pressure, humidity) {
        if (!pressure || !humidity)
          return { text: "Ch·ªù d·ªØ li·ªáu...", icon: "‚è≥", color: "#fff" };
        if (pressure < 995) {
          return { text: "B√£o / Gi√¥ng L·ªõn", icon: "‚õàÔ∏è", color: "#ffebee" };
        } else if (pressure < 1005 && humidity > 70) {
          return { text: "Tr·ªùi M∆∞a", icon: "üåßÔ∏è", color: "#e3f2fd" };
        } else if (pressure > 1015 && humidity < 60) {
          return { text: "N·∫Øng ƒê·∫πp", icon: "‚òÄÔ∏è", color: "#fffde7" };
        } else {
          return { text: "Nhi·ªÅu M√¢y", icon: "‚òÅÔ∏è", color: "#f5f5f5" };
        }
      }

      // 4. [M·ªöI] H√ÄM L·∫§Y T√äN ƒê·ªäA CH·ªà (QU·∫¨N/HUY·ªÜN) T·ª™ T·ªåA ƒê·ªò
      // Bi·∫øn l∆∞u v·ªã tr√≠ c≈© ƒë·ªÉ kh√¥ng g·ªçi API li√™n t·ª•c n·∫øu v·ªã tr√≠ kh√¥ng ƒë·ªïi
      let lastLat = 0;
      let lastLon = 0;

      async function getAddressName(lat, lon) {
        // T√≠nh kho·∫£ng c√°ch s∆° b·ªô, n·∫øu thi·∫øt b·ªã di chuy·ªÉn √≠t h∆°n ~100m (0.001 ƒë·ªô) th√¨ kh√¥ng g·ªçi l·∫°i API
        if (
          Math.abs(lat - lastLat) < 0.001 &&
          Math.abs(lon - lastLon) < 0.001
        ) {
          return; // V·ªã tr√≠ ch∆∞a thay ƒë·ªïi ƒë√°ng k·ªÉ, tho√°t h√†m
        }

        lastLat = lat;
        lastLon = lon;

        document.getElementById("address-text").innerText =
          "ƒêang c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ...";

        try {
          // G·ªçi API mi·ªÖn ph√≠ c·ªßa OpenStreetMap
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1`,
            {
              headers: {
                "User-Agent": "ESP32-Weather-Station-Student-Project",
              },
            }
          );
          const data = await response.json();

          if (data && data.address) {
            // ∆Øu ti√™n l·∫•y Qu·∫≠n/Huy·ªán
            const district =
              data.address.city_district ||
              data.address.district ||
              data.address.county ||
              data.address.suburb;
            const city = data.address.city || data.address.state;

            let locationStr = "";
            if (district) locationStr += district;
            if (district && city) locationStr += ", ";
            if (city) locationStr += city;

            document.getElementById("address-text").innerText =
              locationStr || "Kh√¥ng x√°c ƒë·ªãnh t√™n";
          }
        } catch (error) {
          console.error("L·ªói l·∫•y ƒë·ªãa ch·ªâ:", error);
          document.getElementById("address-text").innerText =
            "L·ªói m·∫°ng ƒë·ªãnh v·ªã";
        }
      }

      // 5. L·∫ÆNG NGHE D·ªÆ LI·ªÜU REALTIME
      function listenLatest() {
        db.ref("data").on("value", (snap) => {
          const data = snap.val();
          if (!data) return;

          const temp = data.temp ?? 0;
          const hum = data.hum ?? 0;
          let press = data.press ?? 0;
          if (press > 2000) press = press / 100;
          const light = data.light ?? 0;
          const lat = data.lat;
          const lon = data.lon;

          // C·∫≠p nh·∫≠t s·ªë li·ªáu
          document.getElementById("kpi-temp").innerText =
            temp.toFixed(1) + " ¬∞C";
          document.getElementById("kpi-hum").innerText = hum.toFixed(0) + " %";
          document.getElementById("kpi-press").innerText =
            press.toFixed(1) + " hPa";
          document.getElementById("kpi-light").innerText =
            light.toFixed(0) + " %";

          const now = new Date();
          document.getElementById("updated").innerText =
            "C·∫≠p nh·∫≠t: " + now.toLocaleString("vi-VN");

          // X·ª≠ l√Ω d·ª± b√°o
          const forecast = getWeatherForecast(press, hum);
          document.getElementById("kpi-forecast").innerText = forecast.text;
          document.getElementById("kpi-forecast-icon").innerText =
            forecast.icon;
          document.getElementById("card-forecast").style.backgroundColor =
            forecast.color;

          // C·∫≠p nh·∫≠t MAP v√† ƒê·ªäA CH·ªà
          if (lat && lon) {
            const newLatLng = new L.LatLng(lat, lon);
            marker.setLatLng(newLatLng);
            map.setView(newLatLng);

            // [M·ªöI] G·ªçi h√†m l·∫•y t√™n Qu·∫≠n
            getAddressName(lat, lon);
          }
        });
      }

      listenLatest();
    </script>
  </body>
</html>
